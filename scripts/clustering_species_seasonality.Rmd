---
title: "Seasonality"
author: "Conor Tompkins"
date: "5/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(tidyverse)
library(lubridate)
library(janitor)
library(vroom)
library(broom)

theme_set(theme_bw())
```

## Including Plots

You can also embed plots, for example:

```{r pressure}
df <- vroom("data/ebd_US-PA-003_201001_202003_relFeb-2020.zip", delim = "\t") %>% 
  clean_names() %>% 
  mutate_at(vars(observer_id, locality, observation_date, time_observations_started, protocol_type), str_replace_na, "NA") %>% 
  mutate(observation_count = as.numeric(str_replace(observation_count, "X", as.character(NA))),
         observation_event_id = str_c(observer_id, locality, observation_date, time_observations_started, sep = "-"),
         observation_date = ymd(observation_date)) %>%
  filter(all_species_reported == 1)
```

```{r}
df_top_protocols <- df %>% 
  count(protocol_type, sort = TRUE) %>% 
  slice(1:2)

df <- df %>% 
  semi_join(df_top_protocols) %>% 
  filter(year(observation_date) >= 2016)
```

```{r}
df_species_count <- df %>% 
  group_by(common_name) %>% 
  summarize(observation_count = sum(observation_count, na.rm = TRUE)) %>% 
  arrange(desc(observation_count))
```



```{r}
df %>% 
  count(observation_date) %>% 
  ggplot(aes(observation_date, n)) +
    geom_line()
```


```{r}
months <- df %>% 
  mutate(observation_month = month(observation_date, label = TRUE)) %>% 
  distinct(observation_month) %>% 
  pull(observation_month)

df_seasonality <- df %>% 
  mutate(observation_month = month(observation_date, label = TRUE),
         observation_year = year(observation_date)) %>% 
  group_by(common_name, observation_year, observation_month) %>% 
  summarize(observation_count = sum(observation_count, na.rm = TRUE)) %>% 
  group_by(common_name, observation_month) %>% 
  summarize(observation_count_mean = mean(observation_count) %>% round(1)) %>% 
  ungroup() %>% 
  complete(common_name, observation_month = months) %>% 
  replace_na(list(observation_count_mean = 0)) %>% 
  arrange(common_name, observation_month)
```


```{r}
df_seasonality %>% 
  ggplot(aes(observation_month, observation_count_mean)) +
    geom_boxplot()
```


```{r}
df_seasonality %>% 
  ggplot(aes(observation_month, observation_count_mean)) +
    geom_jitter(alpha = .1)
```


```{r}
df_bird_sample <- df_seasonality %>% 
  ungroup() %>% 
  distinct(common_name) %>% 
  sample_n(200, replace = FALSE)
```
```{r}
vec_common_name <- df_seasonality %>% 
  pivot_wider(names_from = observation_month, values_from = observation_count_mean, names_prefix = "month_") %>% 
  clean_names() %>% 
  arrange(month_jan, month_feb, month_mar, month_apr, month_may, month_jun, month_jul, month_aug, month_sep, month_oct, month_nov, month_dec) %>% 
  pull(common_name)
```

```{r fig.height=16, fig.width=12}
df_seasonality %>%
  #semi_join(df_bird_sample) %>% 
  semi_join(df_species_count %>% slice(1:200)) %>% 
  mutate(common_name = factor(common_name, levels = vec_common_name),
         observation_count_mean_log10 = log10(observation_count_mean),
         observation_count_mean_log10 = case_when(is.infinite(observation_count_mean_log10) ~ 0,
                                                  TRUE ~ observation_count_mean_log10)
         #observation_count_mean_log10 = scales::pseudo_log_trans(observation_count_mean, base = 10)
         ) %>%
  ggplot(aes(observation_month, common_name, fill = observation_count_mean_log10)) +
    geom_tile() +
    coord_equal() +
    scale_fill_viridis_c() +
    scale_x_discrete(expand = c(0,0)) +
    scale_y_discrete(expand = c(0,0)) +
    theme(panel.grid = element_blank(),
          axis.text.y = element_blank())
```

```{r}
df_seasonality %>% 
  filter(common_name != "Ring-billed Gull") %>% 
  ggplot(aes(observation_month, observation_count_mean, group = common_name)) +
    geom_polygon(fill = "black", color = NA, alpha = .1) +
    coord_polar()
```

```{r}
df_seasonality %>% 
  filter(is.na(observation_count_mean))

df_seasonality_numeric <- df_seasonality %>% 
  pivot_wider(names_from = observation_month, values_from = observation_count_mean, names_prefix = "month_") %>% 
  clean_names()

```

```{r}
tidy(df_kmeans)
```


```{r}
glance(df_kmeans)
```


```{r}
kclusts <- tibble(k = 1:9) %>%
  mutate(
    kclust = map(k, ~kmeans(df_seasonality_numeric, .x)),
    tidied = map(kclust, tidy),
    glanced = map(kclust, glance),
    augmented = map(kclust, augment, df_seasonality_numeric)
  )

kclusts
```


```{r}
clusters <- kclusts %>%
  unnest(tidied)

assignments <- kclusts %>% 
  unnest(augmented)

clusterings <- kclusts %>%
  unnest(glanced)
```

```{r}
ggplot(assignments, aes(month_jan, month_aug)) +
  geom_point(aes(color = .cluster)) + 
  facet_wrap(~ k)
```


```{r}
ggplot(clusterings, aes(k, tot.withinss)) +
  geom_line()
```




```{r}
df_kmeans <- df_seasonality_numeric %>% 
  select(-common_name) %>% 
  kmeans(centers = 5)
```

```{r}
df_clustered <- augment(df_kmeans, df_seasonality_numeric) %>% 
  select(common_name, .cluster)
```

```{r}
df_seasonality %>%
  #semi_join(df_bird_sample) %>% 
  semi_join(df_species_count %>% slice(1:200)) %>% 
  left_join(df_clustered) %>% 
  mutate(common_name = factor(common_name, levels = vec_common_name),
         observation_count_mean_log10 = log10(observation_count_mean),
         observation_count_mean_log10 = case_when(is.infinite(observation_count_mean_log10) ~ 0,
                                                  TRUE ~ observation_count_mean_log10)
         #observation_count_mean_log10 = scales::pseudo_log_trans(observation_count_mean, base = 10)
         ) %>%
  ggplot(aes(observation_month, common_name, fill = observation_count_mean_log10)) +
    geom_tile() +
    facet_wrap(~.cluster, nrow = 1) +
    coord_equal() +
    scale_fill_viridis_c() +
    scale_x_discrete(expand = c(0,0)) +
    scale_y_discrete(expand = c(0,0)) +
    theme(panel.grid = element_blank(),
          axis.text.y = element_blank())
```


```{r}
```


```{r}
```


